--- busybox/examples/depmod.pl.orig	2008-02-25 21:24:55.000000000 +0300
+++ busybox/examples/depmod.pl	2008-02-25 22:00:40.000000000 +0300
@@ -100,6 +100,8 @@
 foreach my $obj ( @liblist ){
     # turn the input file name into a target tag name
     my ($tgtname) = $obj =~ m-(/lib/modules/.*)$-;
+    
+    $tgtname = "/opt" . $tgtname;
 
     warn "\nMODULE = $tgtname\n" if $verbose;
 
diff -urBp '-x*.o' '-x.*' busybox-1.13.2/modutils/insmod.c busybox/modutils/insmod.c
--- busybox-1.13.2/modutils/insmod.c	2008-11-09 20:28:03.000000000 +0300
+++ busybox/modutils/insmod.c	2009-02-07 22:44:05.000000000 +0300
@@ -9,12 +9,17 @@
 
 #include "libbb.h"
 #include "modutils.h"
+#include <sys/utsname.h>                                                        
+#include <fnmatch.h> 
 
 int insmod_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int insmod_main(int argc UNUSED_PARAM, char **argv)
 {
+	struct utsname uts;
+	struct stat st;
 	char *filename;
-	int rc;
+	FILE *fp = NULL;
+	int rc, len;
 
 	USE_FEATURE_2_4_MODULES(
 		getopt32(argv, INSMOD_OPTS INSMOD_ARGS);
@@ -25,6 +30,26 @@ int insmod_main(int argc UNUSED_PARAM, c
 	if (!filename)
 		bb_show_usage();
 
+	/* Get a filedesc for the module.  Check we we have a complete path */
+	if (stat(filename, &st) < 0 || !S_ISREG(st.st_mode) ||
+		(fp = fopen(filename, "r")) == NULL) {
+                /* Hmm.  Could not open it.  First search under /lib/modules/`uname -r` */
+    		xchdir("/lib/modules");
+	        uname(&uts);
+    		xchdir(uts.release);
+
+		len = strlen(filename);
+		if (get_linux_version_code() < KERNEL_VERSION(2,6,0)) {
+			if (len >= 2 && strncmp(&filename[len - 2], ".o", 2) !=0 )
+				filename = xasprintf("%s.o", filename);
+		} else {
+			if (len >= 3 && strncmp(&filename[len - 3], ".ko", 3) !=0 )
+				filename = xasprintf("%s.ko", filename);
+		}
+	}
+	if (fp != NULL)
+		fclose(fp);
+
 	rc = bb_init_module(filename, parse_cmdline_module_options(argv));
 	if (rc)
 		bb_error_msg("cannot insert '%s': %s", filename, moderror(rc));
