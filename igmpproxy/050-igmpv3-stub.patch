--- igmpproxy/src/igmp.c	2011-10-20 17:54:47.201485000 +0000
+++ igmpproxy.current/src/igmp.c	2011-10-20 15:51:17.000000000 +0000
@@ -40,6 +40,7 @@
 // Globals                  
 uint32_t     allhosts_group;          /* All hosts addr in net order */
 uint32_t     allrouters_group;          /* All hosts addr in net order */
+uint32_t     alligmp3_group;          /* IGMPv3 addr in net order */
               
 extern int MRouterFD;
 
@@ -74,6 +75,7 @@ void initIgmp() {
 
     allhosts_group   = htonl(INADDR_ALLHOSTS_GROUP);
     allrouters_group = htonl(INADDR_ALLRTRS_GROUP);
+    alligmp3_group   = htonl(INADDR_ALLIGMPV3_GROUP);
 }
 
 /**
@@ -86,6 +88,7 @@ char *igmpPacketKind(u_int type, u_int c
     case IGMP_MEMBERSHIP_QUERY:     return  "Membership query  ";
     case IGMP_V1_MEMBERSHIP_REPORT:  return "V1 member report  ";
     case IGMP_V2_MEMBERSHIP_REPORT:  return "V2 member report  ";
+    case IGMP_V3_MEMBERSHIP_REPORT:  return "V3 member report  ";
     case IGMP_V2_LEAVE_GROUP:        return "Leave message     ";
     
     default:
@@ -191,7 +194,12 @@ void acceptIgmp(int recvlen) {
         acceptGroupReport(src, group, igmp->igmp_type);
         return;
     
+    case IGMP_V3_MEMBERSHIP_REPORT:
+        sendGeneralMembershipQuery();
+        return;
+    
     case IGMP_V2_LEAVE_GROUP:
+    
         acceptLeaveMessage(src, group);
         return;
     
--- igmpproxy/src/igmpproxy.h	2011-10-20 17:54:47.211485000 +0000
+++ igmpproxy.current/src/igmpproxy.h	2011-10-20 17:23:18.000000000 +0000
@@ -208,6 +208,7 @@ struct Config *getCommonConfig();
 */
 extern uint32_t allhosts_group;
 extern uint32_t allrouters_group;
+extern uint32_t alligmp3_group;
 void initIgmp(void);
 void acceptIgmp(int);
 void sendIgmp (uint32_t, uint32_t, int, int, uint32_t,int);
--- igmpproxy/src/os-dragonfly.h	2009-05-13 19:43:18.000000000 +0000
+++ igmpproxy.current/src/os-dragonfly.h	2011-10-20 16:17:52.000000000 +0000
@@ -3,6 +3,10 @@
 #include <netinet/ip.h>
 #include <netinet/igmp.h>
 
+#define IGMP_V3_MEMBERSHIP_REPORT 0x22
+
+#define INADDR_ALLIGMPV3_GROUP ((in_addr_t) 0xe0000016)
+
 static inline u_short ip_data_len(const struct ip *ip)
 {
 	return ip->ip_len;
--- igmpproxy/src/os-freebsd.h	2009-10-05 18:07:06.000000000 +0000
+++ igmpproxy.current/src/os-freebsd.h	2011-10-20 16:17:55.000000000 +0000
@@ -11,6 +11,9 @@
 #define IGMP_V2_MEMBERSHIP_REPORT IGMP_v2_HOST_MEMBERSHIP_REPORT
 #define IGMP_V2_LEAVE_GROUP IGMP_HOST_LEAVE_MESSAGE
 #endif
+#define IGMP_V3_MEMBERSHIP_REPORT 0x22
+
+#define INADDR_ALLIGMPV3_GROUP ((in_addr_t) 0xe0000016)
 
 static inline u_short ip_data_len(const struct ip *ip)
 {
--- igmpproxy/src/os-linux.h	2009-05-13 19:43:18.000000000 +0000
+++ igmpproxy.current/src/os-linux.h	2011-10-20 16:17:47.000000000 +0000
@@ -4,6 +4,10 @@
 #include <netinet/ip.h>
 #include <netinet/igmp.h>
 
+#define IGMP_V3_MEMBERSHIP_REPORT 0x22
+
+#define INADDR_ALLIGMPV3_GROUP ((in_addr_t) 0xe0000016)
+
 static inline u_short ip_data_len(const struct ip *ip)
 {
 	return ntohs(ip->ip_len) - (ip->ip_hl << 2);
--- igmpproxy/src/os-netbsd.h	2009-05-13 19:43:18.000000000 +0000
+++ igmpproxy.current/src/os-netbsd.h	2011-10-20 17:27:24.000000000 +0000
@@ -6,8 +6,11 @@
 #define IGMP_MEMBERSHIP_QUERY IGMP_HOST_MEMBERSHIP_QUERY
 #define IGMP_V1_MEMBERSHIP_REPORT IGMP_v1_HOST_MEMBERSHIP_REPORT
 #define IGMP_V2_MEMBERSHIP_REPORT IGMP_v2_HOST_MEMBERSHIP_REPORT
+#define IGMP_V3_MEMBERSHIP_REPORT 0x22
 #define IGMP_V2_LEAVE_GROUP IGMP_HOST_LEAVE_MESSAGE
 
+#define INADDR_ALLIGMPV3_GROUP ((in_addr_t) 0xe0000016)
+
 static inline u_short ip_data_len(const struct ip *ip)
 {
 	return ip->ip_len;
--- igmpproxy/src/os-openbsd.h	2009-05-13 19:43:18.000000000 +0000
+++ igmpproxy.current/src/os-openbsd.h	2011-10-20 17:27:31.000000000 +0000
@@ -6,9 +6,11 @@
 #define IGMP_MEMBERSHIP_QUERY IGMP_HOST_MEMBERSHIP_QUERY
 #define IGMP_V1_MEMBERSHIP_REPORT IGMP_v1_HOST_MEMBERSHIP_REPORT
 #define IGMP_V2_MEMBERSHIP_REPORT IGMP_v2_HOST_MEMBERSHIP_REPORT
+#define IGMP_V3_MEMBERSHIP_REPORT 0x22
 #define IGMP_V2_LEAVE_GROUP IGMP_HOST_LEAVE_MESSAGE
 
 #define INADDR_ALLRTRS_GROUP INADDR_ALLROUTERS_GROUP
+#define INADDR_ALLIGMPV3_GROUP ((in_addr_t) 0xe0000016)
 
 static inline u_short ip_data_len(const struct ip *ip)
 {
--- igmpproxy/src/rttable.c	2011-10-20 17:54:47.211485000 +0000
+++ igmpproxy.current/src/rttable.c	2011-10-20 17:22:46.000000000 +0000
@@ -100,6 +100,10 @@ void initRouteTable() {
             
             //k_join(allrouters_group, Dp->InAdr.s_addr);
             joinMcGroup( getMcGroupSock(), Dp, allrouters_group );
+
+            my_log(LOG_DEBUG, 0, "Joining all igmpv3 multicast routers group %s on vif %s",
+                         inetFmt(alligmp3_group,s1),inetFmt(Dp->InAdr.s_addr,s2));
+            joinMcGroup( getMcGroupSock(), Dp, alligmp3_group );
         }
     }
 }
