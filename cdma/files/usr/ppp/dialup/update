#!/bin/sh

USERNAME=$(nvram get wan_modem_username)
PASSWORD=$(nvram get wan_modem_password)
DIALNO=$(nvram get wan_modem_dialno)
INIT=$(nvram get wan_modem_init)
PORTSPEED=$(nvram get wan_modem_portspeed)

if [ $INIT != "" ]; then
 INIT="'OK' '$INIT'"
fi

grep -q '\"'$USERNAME'\" \* \"'$PASSWORD'\" \*' /tmp/ppp/chap-secrets
CHAP=$?
if [ "$CHAP" != "0" ]; then
  echo \"$USERNAME\" \* \"$PASSWORD\" \*>>/tmp/ppp/chap-secrets
fi
chmod 600 /tmp/ppp/chap-secrets

echo $DEVICE > /tmp/ppp/peers/dialup
echo $PORTSPEED >> /tmp/ppp/peers/dialup
sed -e "s/\\\$username\\\$/$USERNAME/g" /usr/ppp/dialup/dialup >> /tmp/ppp/peers/dialup
echo $(nvram get wan_modem_param_$1) >> /tmp/ppp/peers/dialup

sed -e "s/\\\$dialno\\\$/$DIALNO/g" \
    -e "s/\\\$init\\\$/$INIT/g" -e "/^$/d" /usr/ppp/dialup/dialup.chat > /tmp/ppp/peers/dialup.chat
