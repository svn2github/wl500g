From 2d3f1fd462e2c1a9d8a696a8085befc38545b088
From: Fedor <fedork@ubuntu.(none)>
Date: Fri, 6 Mar 2009 17:18:58 -0500
Subject: [PATCH] Supply storage host number to USB hotplug events.

http://repo.or.cz/w/tomato.git/commitdiff/2d3f1fd462e2c1a9d8a696a8085befc38545b088

---
 linux/drivers/usb/storage/usb.c |    4 +++-
 linux/drivers/usb/usb.c         |    7 +++++++
 linux/include/linux/usb.h       |    2 ++
 3 files changed, 12 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/storage/usb.c b/drivers/usb/storage/usb.c
index bcd87db..1fcae19 100644
--- a/drivers/usb/storage/usb.c
+++ b/drivers/usb/storage/usb.c
@@ -1049,10 +1049,12 @@ static void * storage_probe(struct usb_device *dev, unsigned int ifnum,
 		up(&us_list_semaphore);
 	}
 
+	dev->storage_host_number = ss->host_number + 1;
+
 	printk(KERN_DEBUG 
 	       "WARNING: USB Mass Storage data integrity not assured\n");
 	printk(KERN_DEBUG 
-	       "USB Mass Storage device found at %d\n", dev->devnum);
+	       "USB Mass Storage device found at %d. Host: %d\n", dev->devnum, ss->host_number);
 
 	/* return a pointer for the disconnect function */
 	return ss;
diff --git a/drivers/usb/usb.c b/drivers/usb/usb.c
index 758e693..16a7be4 100644
--- a/drivers/usb/usb.c
+++ b/drivers/usb/usb.c
@@ -882,6 +882,13 @@ static void call_policy_interface (char *verb, struct usb_device *dev, int inter
 		dev->descriptor.idProduct,
 		dev->descriptor.bcdDevice) + 1;
 
+	/* The Scsi storage host #, if there is one. */
+	if (dev->storage_host_number > 0) {
+		envp [i++] = scratch;
+		scratch += sprintf (scratch, "SCSI_HOST=%d",
+			dev->storage_host_number - 1) + 1;
+	}
+
 	/* class-based driver binding models */
 	envp [i++] = scratch;
 	scratch += sprintf (scratch, "TYPE=%d/%d/%d",
diff --git a/include/linux/usb.h b/include/linux/usb.h
index 4aec7cf..31ec665 100644
--- a/include/linux/usb.h
+++ b/include/linux/usb.h
@@ -398,6 +398,8 @@ struct usb_device {
 	struct list_head inodes;
 	struct list_head filelist;
 
+	int storage_host_number;	/* 1+SCSI storage host number. 0 means not set/unknown. */
+
 	/*
 	 * Child devices - these can be either new devices
 	 * (if this is a hub device), or different instances
-- 
1.6.5.GIT
