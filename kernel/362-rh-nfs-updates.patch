Patch from RHEL3 63.EL - NFS performance enhancements and miscellaneous fixes

 fs/lockd/clntproc.c |    2 +-
 fs/nfs/dir.c        |    2 +-
 fs/nfs/nfs2xdr.c    |    2 +-
 fs/nfs/nfs3xdr.c    |    2 +-
 4 files changed, 4 insertions(+), 4 deletions(-)

diff -urNp linux-6080/fs/lockd/clntproc.c linux-6090/fs/lockd/clntproc.c
--- linux-6080/fs/lockd/clntproc.c
+++ linux-6090/fs/lockd/clntproc.c
@@ -146,7 +146,7 @@ nlmclnt_proc(struct inode *inode, int cm
 	 * perform the RPC call asynchronously. */
 	if ((IS_SETLK(cmd) || IS_SETLKW(cmd))
 	    && fl->fl_type == F_UNLCK
-	    && (current->flags & PF_EXITING)) {
+	    && ((current->flags & PF_EXITING) || signalled())) {
 		sigfillset(&current->blocked);	/* Mask all signals */
 		recalc_sigpending(current);
 		spin_unlock_irqrestore(&current->sigmask_lock, flags);
diff -urNp linux-6080/fs/nfs/dir.c linux-6090/fs/nfs/dir.c
--- linux-6080/fs/nfs/dir.c
+++ linux-6090/fs/nfs/dir.c
@@ -493,7 +493,7 @@ int nfs_check_verifier(struct inode *dir
 		return 1;
 	if (nfs_revalidate_inode(NFS_SERVER(dir), dir))
 		return 0;
-	return time_after(dentry->d_time, NFS_MTIME_UPDATE(dir));
+	return time_after_eq(dentry->d_time, NFS_MTIME_UPDATE(dir));
 }
 
 /*
diff -urNp linux-6080/fs/nfs/nfs2xdr.c linux-6090/fs/nfs/nfs2xdr.c
--- a/fs/nfs/nfs2xdr.c	2008-03-24 17:58:11.000000000 -0300
+++ b/fs/nfs/nfs2xdr.c	2008-03-24 17:58:46.000000000 -0300
@@ -574,7 +574,7 @@ nfs_xdr_readlinkres(struct rpc_rqst *req
 	len = ntohl(*strlen);
 	if (len >= rcvbuf->page_len - sizeof(u32) || len > NFS2_MAXPATHLEN) {
 		dprintk("NFS: server returned giant symlink!\n");
-		kunmap(rcvbuf->pages[0]);
+		kunmap_atomic(strlen, KM_USER0);
 		return -ENAMETOOLONG;
         }
 	*strlen = len;
diff -urNp linux-6080/fs/nfs/nfs3xdr.c linux-6090/fs/nfs/nfs3xdr.c
--- a/fs/nfs/nfs3xdr.c	2008-03-24 17:58:18.000000000 -0300
+++ b/fs/nfs/nfs3xdr.c	2008-03-24 18:01:30.000000000 -0300
@@ -779,7 +779,7 @@ nfs3_xdr_readlinkres(struct rpc_rqst *re
 	len = ntohl(*strlen);
 	if (len >= rcvbuf->page_len - sizeof(u32)) {
 		dprintk("NFS: server returned giant symlink!\n");
-		kunmap(rcvbuf->pages[0]);
+		kunmap_atomic(strlen, KM_USER0);
 		return -ENAMETOOLONG;
         }
 	*strlen = len;
