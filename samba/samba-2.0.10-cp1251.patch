--- samba/source/lib/charcnv.c.orig	2000-03-17 01:59:14.000000000 +0300
+++ samba/source/lib/charcnv.c	2005-09-23 23:09:58.391420264 +0400
@@ -213,6 +213,34 @@
 update_map("\370\253\371\246\372\247\373\256\374\376\375\257\376\361");
 }
 
+static void init_1251(void)
+{
+  int i;
+  if (!mapsinited) initmaps();
+
+  /* Do not map undefined characters to some accidental code */
+  for (i = 128; i < 256; i++) 
+  {
+     unix2dos[i] = CTRLZ;
+     dos2unix[i] = CTRLZ;
+  }
+
+/* MSDOS Code Page 866 -> 1251 */
+
+update_map ("\240\377\241\366\242\367\244\375");
+update_map ("\250\360\252\362\257\364");
+update_map ("\260\370\267\372");
+update_map ("\270\361\271\374\272\363\277\365");
+update_map ("\300\200\301\201\302\202\303\203\304\204\305\205\306\206\307\207");
+update_map ("\310\210\311\211\312\212\313\213\314\214\315\215\316\216\317\217");
+update_map ("\320\220\321\221\322\222\323\223\324\224\325\225\326\226\327\227");
+update_map ("\330\230\331\231\332\232\333\233\334\234\335\235\336\236\337\237");
+update_map ("\340\240\341\241\342\242\343\243\344\244\345\245\346\246\347\247");
+update_map ("\350\250\351\251\352\252\353\253\354\254\355\255\356\256\357\257");
+update_map ("\360\340\361\341\362\342\363\343\364\344\365\345\366\346\367\347");
+update_map ("\370\350\371\351\372\352\373\353\374\354\375\355\376\356\377\357");
+}
+
 /*
  * Convert unix to dos
  */
@@ -275,6 +303,8 @@
         init_iso8859_7();
     } else if (strequal (str, "koi8-r")) {
         init_koi8_r();
+    } else if (strequal (str, "1251")) {
+        init_1251();
     } else if (strequal (str, "roman8")) {
         init_roman8();
     } else {
