[PATCH] iptables: fix the very broken handling of redundant addresses

From: Wes Campaigne <westacular>
Date: Thu, 17 Feb 2011 08:38:11 -0500

 (This has been broken since forever, >10 years; the same bit of
 never-could-have-worked-right code has been unchanged between the oldest
 versions I could browse and persists in current git)

---
 ip6tables.c |    3 +--
 iptables.c  |    3 +--
 2 files changed, 2 insertions(+), 4 deletions(-)

diff --git a/ip6tables.c b/ip6tables.c
index 5a1d694..ba5791b 100644
--- a/ip6tables.c
+++ b/ip6tables.c
@@ -733,8 +733,7 @@ parse_hostnetworkmask(const char *name, struct in6_addr **addrpp,
 		j++;
 		for (k = 0; k < j - 1; k++) {
 			if (IN6_ARE_ADDR_EQUAL(&addrp[k], &addrp[j - 1])) {
-				(*naddrs)--;
-				j--;
+				in6addrcpy( &addrp[--j], &addrp[--(*naddrs)] );
 				break;
 			}
 		}
diff --git a/iptables.c b/iptables.c
index 6d36fb8..5849098 100644
--- a/iptables.c
+++ b/iptables.c
@@ -722,8 +722,7 @@ parse_hostnetworkmask(const char *name, struct in_addr **addrpp,
 		addrp[j++].s_addr &= maskp->s_addr;
 		for (k = 0; k < j - 1; k++) {
 			if (addrp[k].s_addr == addrp[j - 1].s_addr) {
-				(*naddrs)--;
-				j--;
+				inaddrcpy( &addrp[--j], &addrp[--(*naddrs)] );
 				break;
 			}
 		}
-- 
1.6.5.GIT
