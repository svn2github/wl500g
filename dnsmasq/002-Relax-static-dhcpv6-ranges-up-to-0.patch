From 64da1266708f29e2ff5553fe636e0ac8fab34652 Mon Sep 17 00:00:00 2001
From: Vladislav Grishenko <themiron@mail.ru>
Date: Sun, 30 Sep 2012 13:50:54 +0600
Subject: [PATCH] Relax static dhcpv6 ranges up to ::/0

---
 src/dhcp6.c  |    8 +++++---
 src/option.c |    3 ++-
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/src/dhcp6.c b/src/dhcp6.c
index 4453ddf..3071699 100644
--- a/src/dhcp6.c
+++ b/src/dhcp6.c
@@ -168,9 +168,11 @@ static int complete_context6(struct in6_addr *local,  int prefix,
       
       for (context = daemon->dhcp6; context; context = context->next)
 	{
-	  if (prefix == context->prefix &&
-	      is_same_net6(local, &context->start6, prefix) &&
-	      is_same_net6(local, &context->end6, prefix))
+	  if (prefix > context->prefix && !(context->flags & CONTEXT_STATIC))
+	    continue;
+	  if (prefix >= context->prefix && 
+	      is_same_net6(local, &context->start6, context->prefix) &&
+	      is_same_net6(local, &context->end6, context->prefix))
 	    {
 	      /* link it onto the current chain if we've not seen it before */
 	      if (context->current == context)
diff --git a/src/option.c b/src/option.c
index 8c7bfbf..7045232 100644
--- a/src/option.c
+++ b/src/option.c
@@ -2157,7 +2157,8 @@ static int one_opt(int option, char *arg, char *errstr, char *gen_err, int comma
 		    if ((new->flags & (CONTEXT_RA_ONLY | CONTEXT_RA_NAME | CONTEXT_RA_STATELESS)) && 
 			new->prefix != 64)
 		      ret_err(_("prefix must be exactly 64 for RA subnets"));
-		    else if (new->prefix < 64)
+		    else if (!(new->flags & CONTEXT_STATIC) &&
+			new->prefix < 64)
 		      ret_err(_("prefix must be at least 64"));
 		  }
 	      }
-- 
1.7.2.5

