From ff5378be47a573110a08c7d6718d7bea1809fef1 Mon Sep 17 00:00:00 2001
From: Vladislav Grishenko <themiron@mail.ru>
Date: Sun, 14 Oct 2012 16:42:43 +0600
Subject: [PATCH] Allow multiple dnsmasq instances and fix DHCPv6 socket creation error reporting

---
 src/dhcp6.c |   30 ++++++++++++++++++++++++------
 1 files changed, 24 insertions(+), 6 deletions(-)

diff --git a/src/dhcp6.c b/src/dhcp6.c
index 4453ddf..f151c9d 100644
--- a/src/dhcp6.c
+++ b/src/dhcp6.c
@@ -31,20 +31,38 @@ static int make_duid1(int index, unsigned int type, char *mac, size_t maclen, vo
 
 void dhcp6_init(void)
 {
-  int fd;
+  int fd = socket(PF_INET6, SOCK_DGRAM, IPPROTO_UDP);
   struct sockaddr_in6 saddr;
+  int oneopt = 1;
 #if defined(IPV6_TCLASS) && defined(IPTOS_CLASS_CS6)
   int class = IPTOS_CLASS_CS6;
 #endif
-  
-  if ((fd = socket(PF_INET6, SOCK_DGRAM, IPPROTO_UDP)) == -1 ||
+
+  if (fd == -1)
+    die(_("cannot create DHCPv6 socket: %s"), NULL, EC_BADNET);
+
+  if (!fix_fd(fd) ||
+      setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, &oneopt, sizeof(oneopt)) == -1 ||
 #if defined(IPV6_TCLASS) && defined(IPTOS_CLASS_CS6)
       setsockopt(fd, IPPROTO_IPV6, IPV6_TCLASS, &class, sizeof(class)) == -1 ||
 #endif
-      !fix_fd(fd) ||
       !set_ipv6pktinfo(fd))
-    die (_("cannot create DHCPv6 socket: %s"), NULL, EC_BADNET);
-  
+    die(_("failed to set options on DHCPv6 socket: %s"), NULL, EC_BADNET);
+
+  /* When bind-interfaces is set, there might be more than one dnmsasq
+     instance binding port 547. That's OK if they serve different networks.
+     Need to set REUSEADDR to make this posible, or REUSEPORT on *BSD. */
+  if (option_bool(OPT_NOWILD) || option_bool(OPT_CLEVERBIND))
+    {
+#ifdef SO_REUSEPORT
+      int rc = setsockopt(fd, SOL_SOCKET, SO_REUSEPORT, &oneopt, sizeof(oneopt));
+#else
+      int rc = setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &oneopt, sizeof(oneopt));
+#endif
+      if (rc == -1)
+	die(_("failed to set SO_REUSE{ADDR|PORT} on DHCPv6 socket: %s"), NULL, EC_BADNET);
+    }
+
   memset(&saddr, 0, sizeof(saddr));
 #ifdef HAVE_SOCKADDR_SA_LEN
   saddr.sin6_len = sizeof(struct sockaddr_in6);
-- 
1.7.2.5

