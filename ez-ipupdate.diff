 
 1. string.h detection
 2. broken configure fix
 3. URL for zoneedit changed to http://dynamic.zoneedit.com
 4. HTTP/301 redirect support by theMIROn <themiron@mail.ru>
 5. Format string vulnerability in syslog handling
    http://bugs.gentoo.org/show_bug.cgi?id=69658
 6. dnsomatic.com support
 7. changed maxintervals down to 1 hour
 
diff -BurpN -x'*.o' router/ez-ipupdate/config.h.in gateway/ez-ipupdate/config.h.in
--- router/ez-ipupdate/config.h.in	2004-11-11 07:26:51.000000000 +0000
+++ gateway/ez-ipupdate/config.h.in	2008-12-20 07:14:17.000000000 +0000
@@ -132,6 +132,9 @@
 /* Define if you have the <stdarg.h> header file.  */
 #undef HAVE_STDARG_H
 
+/* Define if you have the <string.h> header file.  */
+#undef HAVE_STRING_H
+
 /* Define if you have the <sys/socket.h> header file.  */
 #undef HAVE_SYS_SOCKET_H
 
diff -BurpN -x'*.o' router/ez-ipupdate/configure gateway/ez-ipupdate/configure
--- router/ez-ipupdate/configure	2004-11-11 07:26:51.000000000 +0000
+++ gateway/ez-ipupdate/configure	2008-12-20 07:16:10.000000000 +0000
@@ -1505,6 +1505,7 @@ for ac_hdr in arpa/inet.h \
 		  syslog.h \
 		  pwd.h \
 		  stdarg.h \
+		  string.h \
 		  grp.h \
 		  errno.h \
 		  sys/sockio.h \
@@ -1521,6 +1522,8 @@ else
 #line 1522 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
+
+int main() { return 0; }
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
 { (eval echo configure:1527: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
@@ -1565,6 +1568,8 @@ else
 #line 1566 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
+
+int main() { return 0; }
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
 { (eval echo configure:1571: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
diff -BurpN -x'*.o' router/ez-ipupdate/configure.in gateway/ez-ipupdate/configure.in
--- router/ez-ipupdate/configure.in	2004-11-11 07:26:51.000000000 +0000
+++ gateway/ez-ipupdate/configure.in	2008-12-20 07:14:17.000000000 +0000
@@ -65,6 +65,7 @@ AC_CHECK_HEADERS( arpa/inet.h \
 		  syslog.h \
 		  pwd.h \
 		  stdarg.h \
+		  string.h \
 		  grp.h \
 		  errno.h \
 		  sys/sockio.h \
diff -BurpN -x'*.o' router/ez-ipupdate/example-dnsomatic.conf gateway/ez-ipupdate/example-dnsomatic.conf
--- router/ez-ipupdate/example-dnsomatic.conf	1970-01-01 00:00:00.000000000 +0000
+++ gateway/ez-ipupdate/example-dnsomatic.conf	2009-02-26 18:45:04.000000000 +0000
@@ -0,0 +1,26 @@
+#!/usr/local/bin/ez-ipupdate -c
+#
+# example config file for ez-ipupdate
+#
+# this file is actually executable!
+#
+
+service-type=dnsomatic
+user=myuserid:mypassword
+host=all.dnsomatic.com
+interface=eth1
+max-interval=2073600
+
+# please create this file and ensure that the user that ez-ipupdate is running
+# as has write permissions to it then uncomment this line, if you don't your
+# dyndns account will probably get banned. if you run ez-ipupdate as root (bad
+# idea, use "run-as-user") then you can just uncomment this line.
+#cache-file=/etc/ez-ipupdate.cache.eth1
+
+# for the mean time we'll just use a cache file in the temp directory
+cache-file=/tmp/ez-ipupdate.cache
+
+# uncomment this once you have everything working how you want and you are
+# ready to have ez-ipupdate running in the background all the time. to stop it
+# you can use "killall -QUIT ez-ipupdate" under linux.
+#daemon
diff -BurpN -x'*.o' router/ez-ipupdate/ez-ipupdate.c gateway/ez-ipupdate/ez-ipupdate.c
--- router/ez-ipupdate/ez-ipupdate.c	2004-11-11 07:26:51.000000000 +0000
+++ gateway/ez-ipupdate/ez-ipupdate.c	2009-06-27 05:00:40.000000000 +0000
@@ -44,6 +44,9 @@
 #define SEND_EMAIL_CMD "mail"
 #endif
 
+#undef HAS_REDIRECT
+// support of HTTP/301 - redirect command
+
 #define EZIP_DEFAULT_SERVER "www.EZ-IP.Net"
 #define EZIP_DEFAULT_PORT "80"
 #define EZIP_REQUEST "/members/update/"
@@ -102,7 +105,7 @@
 #define HN_DEFAULT_PORT "80"
 #define HN_REQUEST "/vanity/update"
 
-#define ZONEEDIT_DEFAULT_SERVER "www.zoneedit.com"
+#define ZONEEDIT_DEFAULT_SERVER "dynamic.zoneedit.com"
 #define ZONEEDIT_DEFAULT_PORT "80"
 #define ZONEEDIT_REQUEST "/auth/dynamic.html"
 
@@ -110,6 +113,10 @@
 #define HEIPV6TB_DEFAULT_PORT "80"
 #define HEIPV6TB_REQUEST "/index.cgi"
 
+#define DNSOMATIC_DEFAULT_SERVER "updates.dnsomatic.com"
+#define DNSOMATIC_DEFAULT_PORT "80"
+#define DNSOMATIC_REQUEST "/nic/update"
+
 #define DEFAULT_TIMEOUT 120
 #define DEFAULT_UPDATE_PERIOD 120
 #define DEFAULT_RESOLV_PERIOD 30
@@ -217,11 +224,11 @@
 #define MIN_UPDATE_PERIOD 10
 // the min/max time to wait if we fail to update
 #define MIN_WAIT_PERIOD 300
-#define MAX_WAIT_PERIOD (2*3600)
+#define MAX_WAIT_PERIOD (1*3600)
 // the min time that max-period can be set to
-#define MIN_MAXINTERVAL (24*3600)
+#define MIN_MAXINTERVAL (1*3600)
 // the max time we will wait if the server tells us to
-#define MAX_WAITRESPONSE_WAIT (24*3600)
+#define MAX_WAITRESPONSE_WAIT (1*3600)
 #define MAX_MESSAGE_LEN 256
 #define ARGLENGTH 32
 #define BLOCK_FILE "/var/run/ez-ipupdate.block"
@@ -548,6 +555,16 @@ struct service_t services[] = {
     HEIPV6TB_DEFAULT_PORT,
     HEIPV6TB_REQUEST
   },
+  { "dnsomatic",
+    { "dnsomatic", 0, 0, },
+    DYNDNS_init,
+    DYNDNS_update_entry,
+    DYNDNS_check_info,
+    DYNDNS_fields_used,
+    DNSOMATIC_DEFAULT_SERVER,
+    DNSOMATIC_DEFAULT_PORT,
+    DNSOMATIC_REQUEST
+  },
 };
 
 static struct service_t *service = NULL;
@@ -859,7 +876,7 @@ void show_message(char *fmt, ...)
     sprintf(buf, "message incomplete because your OS sucks: %s\n", fmt);
 #endif
 
-    syslog(LOG_NOTICE, buf);
+    syslog(LOG_NOTICE, "%s", buf);
   }
   else
   {
@@ -885,7 +902,7 @@ void show_message(char *fmt, ...)
   va_start(args, fmt);
   vsnprintf(buf, sizeof(buf), fmt, args);
   openlog("ddns update", 0, 0);
-  syslog(0, buf);
+  syslog(0, "%s", buf);
   closelog();
   va_end(args);
 }
@@ -4057,19 +4074,28 @@ int ZONEEDIT_update_entry(void)
   int bytes;
   int btot;
   int ret;
+#ifdef HAS_REDIRECT
+  char bserver[128];
+  char brequest[128];
+  int redir_count = 0;
+#endif
+  char *lserver = server;
+  char *lrequest = request;
+
+  redirect_loop:
 
   buf[BUFFER_SIZE] = '\0';
 
-  if(do_connect((int*)&client_sockfd, server, port) != 0)
+  if(do_connect((int*)&client_sockfd, lserver, port) != 0)
   {
     if(!(options & OPT_QUIET))
     {
-      show_message("error connecting to %s:%s\n", server, port);
+      show_message("error connecting to %s:%s\n", lserver, port);
     }
     return(UPDATERES_ERROR);
   }
 
-  snprintf(buf, BUFFER_SIZE, "GET %s?", request);
+  snprintf(buf, BUFFER_SIZE, "GET %s?", lrequest);
   output(buf);
   snprintf(buf, BUFFER_SIZE, "%s=%s&", "host", host);
   output(buf);
@@ -4086,7 +4112,7 @@ int ZONEEDIT_update_entry(void)
   snprintf(buf, BUFFER_SIZE, "User-Agent: %s-%s %s (%s)\015\012", 
       "zoneedit", VERSION, OS, "by Angus Mackay");
   output(buf);
-  snprintf(buf, BUFFER_SIZE, "Host: %s\015\012", server);
+  snprintf(buf, BUFFER_SIZE, "Host: %s\015\012", lserver);
   output(buf);
   snprintf(buf, BUFFER_SIZE, "Authorization: Basic %s\015\012", auth);
   output(buf);
@@ -4141,6 +4167,35 @@ int ZONEEDIT_update_entry(void)
       }
       break;
 
+#ifdef HAS_REDIRECT
+    case 301:
+      *bserver = '\0';
+      *brequest = '\0';
+      if(((bp=strstr(buf, "Location: ")) != NULL) &&      
+	 ((ret=sscanf(bp,"Location: http://%127[^/\r\n]%127[^?\r\n]", bserver, brequest)) > 0) &&
+	 (redir_count++ <= 5))
+      {
+	if(ret==1) snprintf(brequest, 127, "/");
+	lserver = bserver;
+	lrequest = brequest;
+	if(!(options & OPT_QUIET))
+	{
+	  show_message("trying location %u: %s%s\n", redir_count, lserver, lrequest);
+	}
+	goto redirect_loop;
+      }
+      else
+      {	
+	show_message("error processing redirect\n");
+	if(!(options & OPT_QUIET))
+	{
+	  fprintf(stderr, "server output: %s\n", buf);
+        }
+      }
+      return(UPDATERES_ERROR);
+      break;
+#endif
+
     case 401:
       if(!(options & OPT_QUIET))
       {
diff -BurpN -x'*.o' router/ez-ipupdate/Makefile.in gateway/ez-ipupdate/Makefile.in
--- router/ez-ipupdate/Makefile.in	2004-11-11 07:26:51.000000000 +0000
+++ gateway/ez-ipupdate/Makefile.in	2008-12-20 07:14:17.000000000 +0000
@@ -115,7 +115,7 @@ Makefile: $(srcdir)/Makefile.in  $(top_b
 	cd $(top_builddir) \
 	  && CONFIG_FILES=$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
-$(ACLOCAL_M4):  configure.in 
+$(ACLOCAL_M4):
 	cd $(srcdir) && $(ACLOCAL)
 
 config.status: $(srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
@@ -123,11 +123,6 @@ config.status: $(srcdir)/configure $(CON
 $(srcdir)/configure: $(srcdir)/configure.in $(ACLOCAL_M4) $(CONFIGURE_DEPENDENCIES)
 	cd $(srcdir) && $(AUTOCONF)
 
-config.h: stamp-h
-	@if test ! -f $@; then \
-		rm -f stamp-h; \
-		$(MAKE) stamp-h; \
-	else :; fi
 stamp-h: $(srcdir)/config.h.in $(top_builddir)/config.status
 	cd $(top_builddir) \
 	  && CONFIG_FILES= CONFIG_HEADERS=config.h \
@@ -306,7 +301,7 @@ install: install-am
 uninstall-am: uninstall-binPROGRAMS
 uninstall: uninstall-am
 all-am: Makefile $(PROGRAMS) config.h
-all-redirect: all-am
+all-redirect: $(PROGRAMS)
 install-strip:
 	$(MAKE) $(AM_MAKEFLAGS) AM_INSTALL_PROGRAM_FLAGS=-s install
 installdirs:
